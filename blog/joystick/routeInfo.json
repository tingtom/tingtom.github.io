{"template":"../src/containers/Post","sharedHashesByProp":{},"data":{"title":"Joystick trigger support in HL1","slug":"joystick","date":"2025-11-30T00:00:00.000Z","mins":2,"summary":"After releasing the demo for Half-Life Element 64 we had some people asking about controller support so I took a look.","contents":"<p>After releasing the demo for <a href=\"https://store.steampowered.com/app/1625220/HalfLife_Element_64/\">Half-Life: Element 64</a> we had some people asking about controller support so I took a look.</p>\n<h1 id=\"what-already-exists-\">What already exists?</h1>\n<p>Joystick support is already included in the better forks of the HL1 code base, we use the op4 base which added support of using SDL2 for finding joysticks. It still requires some setup in a config as there&#39;s no proper settings for them but once setup properly then it the movement seems ok.</p>\n<h1 id=\"what-s-missing-\">What&#39;s missing?</h1>\n<h2 id=\"there-s-no-trigger-support\">There&#39;s no trigger support</h2>\n<p>Triggers for modern controllers are they&#39;re own axis so they&#39;re not found as buttons for bindings, I added support for the left and right trigger axis to the code and spoofed them to trigger a button press if a threshold is met:</p>\n<p>Increase JOY_MAX_AXIS to 8 and add the new axis</p>\n<pre><code class=\"language-cpp\">#define JOY_MAX_AXES 8\n#define JOY_AXIS_TRIGGER_L 6\n#define JOY_AXIS_TRIGGER_R 7</code></pre>\n<p>in the RawValuePointer method add the new axis:</p>\n<pre><code class=\"language-cpp\">case JOY_AXIS_TRIGGER_L:\n    return SDL_GameControllerGetAxis(s_pJoystick, SDL_CONTROLLER_AXIS_TRIGGERLEFT);\ncase JOY_AXIS_TRIGGER_R:\n    return SDL_GameControllerGetAxis(s_pJoystick, SDL_CONTROLLER_AXIS_TRIGGERRIGHT);</code></pre>\n<p>in IN_JoyMove add the new axis:</p>\n<pre><code class=\"language-cpp\">// Turn trigger presses into key presses using a threshhold, use 31 and 32 due to not having engine access\nif (i == JOY_AXIS_TRIGGER_R)\n{\n    if (fabs(fAxisValue) &gt; joy_triggerrthreshold-&gt;value)\n    {\n        gEngfuncs.Key_Event(K_AUX31, 1);\n    }\n    else\n    {\n        gEngfuncs.Key_Event(K_AUX31, 0);\n    }\n}\nelse if (i == JOY_AXIS_TRIGGER_L)\n{\n    if (fabs(fAxisValue) &gt; joy_triggerlthreshold-&gt;value)\n    {\n        gEngfuncs.Key_Event(K_AUX32, 1);\n    }\n    else\n    {\n        gEngfuncs.Key_Event(K_AUX32, 0);\n    }\n}</code></pre>\n<p>K_AUX31 and K_AUX32 are used because they&#39;re the bottom of the list of what we can use, I tried adding new keys but the engine doesn&#39;t allow us so I had to use them instead.</p>\n<p>I added 2 new cvars for the threshold:</p>\n<pre><code class=\"language-cpp\">joy_triggerrthreshold = gEngfuncs.pfnRegisterVariable(&quot;joytriggerrthreshold&quot;, &quot;0.15&quot;, 0);\njoy_triggerlthreshold = gEngfuncs.pfnRegisterVariable(&quot;joytriggerlthreshold&quot;, &quot;0.15&quot;, 0);</code></pre>\n<p>Then aux32 and aux33 can then be bound like normal buttons to +attack or whatever.</p>\n<h2 id=\"menu-s-are-not-supported-in-keybindings\">Menu&#39;s are not supported in keybindings</h2>\n<p>The engine menu is not supported as a binding on it&#39;s own so I couldn&#39;t bind it to the start button on the controller, in IN_Commands I added some code like this:</p>\n<pre><code class=\"language-cpp\">// Correct key is pressed for joymenukey\nif (LookupJoyMenuKey(joy_menukey-&gt;string) == key_index + i)\n{\n    gEngfuncs.Key_Event(K_ESCAPE, 1);\n}</code></pre>\n<p>This gets the string from the joymenukey cvar and compares them and triggers the escape button on the engine side, this opens and closed the menu like normal. I originally added a normal concommand but the issue is the engine stops listening to button presses when the menu is open but I didn&#39;t want to have to put the controller down to close the menu.</p>\n<p>LookupJoyMenuKey is just a mapping from text to the K_ enum.</p>\n<h2 id=\"joysticks-are-not-picked-up-if-they-re-off\">Joysticks are not picked up if they&#39;re off</h2>\n<p>I noticed that if my controller was off and I opened the game then the controller isn&#39;t picked up, it was annoying so I added a small snippet to IN_JoyMove:</p>\n<pre><code class=\"language-cpp\">if (!joy_avail || 0 == in_joystick-&gt;value)\n{\n    // Check if the count has changed\n    int nJoysticks = SDL_NumJoysticks();\n\n    if (nJoysticks &gt; 0)\n    {\n        IN_StartupJoystick();\n    }\n\n    return;\n}</code></pre>\n"},"path":"blog/joystick"}
